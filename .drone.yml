---
kind: pipeline
type: docker
name: Linux

platform:
  os: linux
  arch: amd64

steps:
- name: cmake
  image: grafin1992/nemu-ci:v1.2
  commands:
  - mkdir build && cd build
  - cmake -G Ninja ../ -DNM_WITH_NETWORK_MAP=ON -DNM_WITH_DBUS=ON -DNM_WITH_REMOTE=ON
  depends_on:
  - clone

- name: codeql
  image: grafin1992/nemu-ci:v1.2
  commands:
  - /codeql/codeql database create lgtm --language=cpp
  - /codeql/codeql database analyze lgtm --format=sarif-latest --output=./codeql-lgtm.sarif cpp-lgtm.qls
  - /codeql/codeql github upload-results --repository="${DRONE_REPO}" --ref="${DRONE_COMMIT_REF}" --commit="${DRONE_COMMIT_SHA}" --sarif=./codeql-lgtm.sarif
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
    _JAVA_OPTIONS: -Xmx512m
  depends_on:
  - clone

- name: cppcheck
  image: grafin1992/nemu-ci:v1.2
  commands:
  - ./ci/cppcheck-sarif.py -a "--enable=all --suppress=missingIncludeSystem --xml -q" -o ./cppcheck.sarif -p src/ ./src
  - /codeql/codeql github upload-results --repository="${DRONE_REPO}" --ref="${DRONE_COMMIT_REF}" --commit="${DRONE_COMMIT_SHA}" --sarif=./cppcheck.sarif
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  depends_on:
  - clone

- name: codespell
  image: grafin1992/nemu-ci:v1.2
  commands:
  - ./ci/codespell-sarif.py -a "-q 3 -L fo,ser,ans,chello -S ../lgtm,../_lgtm_detected_source_root" -o ./codespell.sarif ./
  - /codeql/codeql github upload-results --repository="${DRONE_REPO}" --ref="${DRONE_COMMIT_REF}" --commit="${DRONE_COMMIT_SHA}" --sarif=./codespell.sarif
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  depends_on:
  - clone

- name: build
  image: grafin1992/nemu-ci:v1.2
  commands:
  - cd build
  - ninja
  depends_on:
  - cmake

trigger:
  branch:
  - master

---
kind: pipeline
type: docker
name: musl

platform:
  os: linux
  arch: amd64

steps:
- name: cmake
  image: grafin1992/nemu-musl:v1.0
  commands:
  - mkdir build && cd build
  - cmake ../ -DNM_WITH_NETWORK_MAP=ON -DNM_WITH_DBUS=ON -DNM_WITH_REMOTE=ON
  depends_on:
  - clone

- name: build
  image: grafin1992/nemu-musl:v1.0
  commands:
  - cd build
  - make
  depends_on:
  - cmake

trigger:
  branch:
  - master

---
kind: signature
hmac: 2732c805589445df217a34fa60fc160d8c4f7385f1175d47696938b6afe0bb4d

...
